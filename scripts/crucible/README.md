# crucible Scripts

> Auto-generated by `scripts/generate-readme.sh` - do not edit manually

## Scripts

| Script | Description |
|--------|-------------|
| `attach-volumes-to-proxmox.sh` | Attach Crucible volumes to all Proxmox hosts<br>Usage: ./attach-volumes-to-proxmox.sh [CRUCIBLE_IP]<br>Deploys crucible-nbd-server and setup script to each Proxmox host,<br>configuring NBD connections to Crucible downstairs processes. |
| `backup-configs-to-crucible.sh` | Backup config files from Proxmox hosts to Crucible storage<br>Usage: ./backup-configs-to-crucible.sh [HOST]<br>Backs up configs that may not be in git or are host-specific:<br>- /etc/pve/* (Proxmox cluster config)<br>- /etc/network/interfaces<br>- /etc/hosts<br>- /etc/systemd/system/crucible-* (Crucible services)<br>- LXC configs<br>- VM configs<br>Each host backs up to its own /mnt/crucible-storage/configs/ |
| `backup-services-to-crucible.sh` | Backup service configs from VMs/LXCs to Crucible storage<br>Usage: ./backup-services-to-crucible.sh [SERVICE]<br>Services backed up:<br>- HAOS (Home Assistant OS) - configuration.yaml, automations, scripts, secrets<br>- Frigate - config.yml, model files<br>- Ollama - model list, Modelfiles<br>Backups stored in /mnt/crucible-storage/services/ on pve |
| `build-nbd-server.sh` | Build patched crucible-nbd-server with --address support on proper-raptor<br>This patches the NBD server to support a custom listen address, required<br>for per-VM volumes where each VM needs its own NBD port.<br>After building, the binary is copied to /home/ubuntu/crucible-nbd-server |
| `create-vm-disk-volumes.sh` | Create Crucible VM disk volumes for each Proxmox host<br>This creates separate Crucible volumes (each with 3 regions) that can be<br>attached to VMs on each Proxmox host via NBD.<br>Architecture:<br>- Each Proxmox host gets its own volume<br>- Each volume has 3 regions on proper-raptor (ports 3820-3822, 3830-3832, etc.)<br>- NBD server on Proxmox host connects to the 3 regions |
| `create-vm-volume.sh` | Create a per-VM Crucible volume for HA-ready storage<br>Usage: create-vm-volume.sh <VMID> [SIZE_GB]<br>Creates 3 downstairs regions for a specific VM on proper-raptor.<br>Any Proxmox host can connect to this volume, enabling HA failover.<br>Port allocation scheme:<br>VM-200: 3900, 3901, 3902<br>VM-201: 3910, 3911, 3912<br>VM-2XX: 3900 + ((VMID - 200) * 10), +1, +2<br>Capacity: VMIDs 200-299 = 100 VMs (ports 3900-4892) |
| `deploy-ha-storage.sh` | Deploy HA-ready Crucible storage to all Proxmox hosts<br>This script deploys:<br>1. crucible-nbd-server binary<br>2. crucible-nbd-wrapper.sh (timestamp generation)<br>3. crucible-vm@.service template<br>4. crucible-vm-connect@.service template<br>5. HA hook script<br>After deployment, any host can start any VM using Crucible storage. |
| `deploy-nbd-to-proxmox.sh` | Deploy crucible-nbd-server to all Proxmox hosts and configure shared storage<br>This creates an NBD block device on each Proxmox host connected to the<br>3 downstairs on proper-raptor, providing Ceph-like shared storage. |
| `deploy-simple-ha-storage.sh` | Deploy simple HA-ready Crucible storage to all Proxmox hosts<br>Architecture:<br>- Each host gets ONE NBD device (/dev/nbd0) backed by Crucible<br>- ZFS pool on NBD for caching, compression, snapshots<br>- Proxmox uses it as directory storage at /mnt/crucible-storage<br>HA comes from Crucible's 3-way replication, not filesystem-level |
| `ha-hook.sh` | Proxmox HA Hook for Crucible Storage<br>This hook is called by the Proxmox HA manager when VMs start/stop/migrate.<br>It manages the Crucible NBD connection for per-VM volumes.<br>Install location: /etc/pve/ha/resources.d/ (cluster-wide)<br>or /var/lib/pve-cluster/hooks/ (node-specific)<br>Called with: $0 <action> <vmid> [target_node]<br>action: start, stop, migrate<br>vmid: VM ID (e.g., 200)<br>target_node: (migrate only) destination node<br>For Crucible HA storage, VMs must use VMID 200-299. |
| `replicate-crucible-storage.sh` | Replicate Crucible storage contents across all Proxmox hosts<br>Usage: ./replicate-crucible-storage.sh [--dry-run]<br>Syncs /mnt/crucible-storage/{secrets,services,configs} from pve to all other hosts.<br>This provides redundancy - if one host loses its Crucible connection, others have copies. |
| `setup-3-downstairs.sh` | Setup 3 Crucible downstairs processes on proper-raptor<br>Required for Crucible replication/consensus to work<br>Usage: ./setup-3-downstairs.sh |
| `setup-nbd-client.sh` | Setup NBD client on a Proxmox host - runs ON the host<br>Usage: setup-nbd-client.sh CRUCIBLE_IP PORT1 PORT2 PORT3<br>GENERATION NUMBER:<br>Uses $(date +%s) (Unix timestamp) per Oxide's pattern (crucible README line 68).<br>This ensures gen is always >= stored value, even after writes/reboots.<br>See: https://github.com/oxidecomputer/crucible/blob/main/README.md |
| `setup-node-exporter.sh` | Install node_exporter on proper-raptor for Prometheus monitoring |
| `setup-proper-raptor-network.sh` | Setup proper-raptor network: USB 2.5GbE with bridge (like Proxmox hosts)<br>This converts proper-raptor from netplan to ifupdown with a bridge,<br>matching the proven fun-bedbug configuration.<br>After running: unplug built-in NIC cable, keep only USB 2.5GbE connected |
| `setup-proper-raptor-user.sh` | Setup gshiva user on proper-raptor |
| `start-downstairs.sh` | Start Crucible downstairs on proper-raptor<br>Usage: ./start-downstairs.sh [--foreground] |
| `status-ha-storage.sh` | Check status of HA-ready Crucible storage across all hosts<br>Usage: status-ha-storage.sh [VMID]<br>Without VMID: Shows all VM volumes and their status<br>With VMID:    Shows detailed status for specific VM |
| `sync-secrets-to-crucible.sh` | Sync sensitive configs to Crucible storage as backup<br>Usage: ./sync-secrets-to-crucible.sh [--dry-run]<br>Backs up sensitive files that can't be checked into git:<br>- SOPS age keys<br>- SSH private keys<br>- .env files with credentials<br>- Certificate private keys<br>Files are synced to /mnt/crucible-storage/secrets/ on each Proxmox host.<br>Crucible provides redundancy when multiple sleds are configured. |
| `test-ha-failover.sh` | Test HA failover for Crucible per-VM volumes<br>Usage: test-ha-failover.sh <VMID> <HOST1> <HOST2><br>This script tests that:<br>1. Host1 can connect to a VM's volume<br>2. Host1 can be disconnected<br>3. Host2 can take over (higher generation)<br>4. Host1 cannot reconnect with stale generation |

*Generated: 2026-01-25*
