# RCA: Proxmox 401 "Invalid PVE Ticket" on chief-horse

**Date**: 2025-12-27
**Duration**: ~1 hour
**Severity**: Medium (single node UI access degraded)
**Status**: Resolved

## Summary

The Proxmox cluster UI showed "permission denied - invalid PVE ticket (401)" errors when viewing chief-horse from other nodes. Direct access to chief-horse:8006 worked fine.

## Impact

- Could not manage chief-horse (VMs 109, 116) from cluster UI
- Direct access at https://192.168.4.19:8006 still worked
- No impact to running VMs or services

## Root Cause

**Clock drift of ~9 minutes** on chief-horse caused PVE ticket validation failures.

Proxmox uses time-sensitive authentication tickets for inter-node communication. When chief-horse's clock drifted ~552 seconds behind other nodes, tickets generated by other nodes appeared "from the future" to chief-horse, causing 401 rejections.

### Why the clock drifted

The chrony NTP configuration on chief-horse pointed to an unreachable IPv6 address:
```
server 2600:1700:7270:933f::1734 iburst
```

This was likely auto-configured during initial setup but became unreachable, causing chrony to run without synchronization (`Stratum: 0`).

## Timeline

| Time (UTC) | Event |
|------------|-------|
| ~19:00 | User noticed 401 errors in Proxmox UI for chief-horse |
| 19:12 | Logs showed SSL key loading failures (symptom, not cause) |
| 19:16 | Node rebooted (unclear trigger), SSL errors cleared |
| 20:06 | Investigation revealed 9-minute clock drift |
| 20:16 | Time synced via chronyc makestep |
| 20:17 | Services restarted, cluster UI working |

## Resolution

1. Added public NTP pool to chrony config:
   ```bash
   echo 'pool pool.ntp.org iburst' >> /etc/chrony/chrony.conf
   ```

2. Restarted chrony and forced time step:
   ```bash
   systemctl restart chronyd
   chronyc makestep
   ```

3. Restarted PVE services:
   ```bash
   systemctl restart pvedaemon pveproxy
   ```

## Prevention

1. **Monitoring**: Add NTP sync status to monitoring
   - Alert if `chronyc tracking` shows Stratum 0 or large offset

2. **Configuration**: Ensure all Proxmox nodes have reliable NTP sources
   - Run `scripts/proxmox/check-ntp-sync.sh` periodically

3. **Runbook**: Created `docs/runbooks/proxmox-401-invalid-ticket.md`

## Lessons Learned

1. **Time sync issues cause cryptic auth errors** - 401 "invalid ticket" doesn't mention time
2. **Direct node access working + cluster access failing = likely time drift**
3. **Check NTP status early** when debugging inter-node auth issues

## Related

- Runbook: `docs/runbooks/proxmox-401-invalid-ticket.md`
- Script: `scripts/proxmox/check-ntp-sync.sh`

## Tags

proxmox, pve, 401, authentication, ntp, chrony, time-drift, cluster, chief-horse
