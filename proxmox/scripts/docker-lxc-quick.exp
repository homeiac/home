#!/usr/bin/expect -f

# Quick timeouts for fast feedback - only container creation should be slow
set timeout 10
log_user 1

# Set environment properly  
set env(TERM) "xterm"

spawn bash -c "curl -fsSL https://github.com/community-scripts/ProxmoxVE/raw/main/ct/docker.sh | bash"

# Step 1: Handle SSH dialog (should be quick)
expect {
    "*SSH DETECTED*" {
        puts "âœ“ SSH dialog detected - selecting Yes"
        send "\r"
    }
    timeout {
        puts "âœ— TIMEOUT: SSH dialog not found in 10s"
        exit 1
    }
}

# Step 2: Handle SSH confirmation (should be quick) 
expect {
    "*Proceed using SSH*" {
        puts "âœ“ SSH confirmation - proceeding"
        send "\r"
    }
    "*Choose Type*" {
        puts "âœ“ Skipped to container type selection"
    }
    timeout {
        puts "âœ— TIMEOUT: SSH confirmation failed in 10s"
        exit 1
    }
}

# Step 3: Container type selection (should be quick)
expect {
    "*Choose Type*" {
        puts "âœ“ Container type dialog - selecting Advanced"
        send "\t\r"
    }
    timeout {
        puts "âœ— TIMEOUT: Container type dialog not found in 10s"
        exit 1
    }
}

# Step 4: Container ID (should be quick)
expect {
    "*Container ID*" {
        puts "âœ“ Container ID dialog - entering 104"
        send "104\r"
    }
    timeout {
        puts "âœ— TIMEOUT: Container ID dialog not found in 10s"
        exit 1
    }
}

# Step 5: Hostname (should be quick)
expect {
    "*Hostname*" {
        puts "âœ“ Hostname dialog - entering docker-webtop"
        send "docker-webtop\r"
    }
    timeout {
        puts "âœ— TIMEOUT: Hostname dialog not found in 10s"
        exit 1
    }
}

# Step 6: Disk size (should be quick)
expect {
    "*Disk Size*" {
        puts "âœ“ Disk size dialog - entering 50GB"
        send "50\r"
    }
    timeout {
        puts "âœ— TIMEOUT: Disk size dialog not found in 10s"
        exit 1
    }
}

# Step 7: CPU cores (should be quick)
expect {
    "*CPU Core*" {
        puts "âœ“ CPU cores dialog - entering 4"
        send "4\r"
    }
    timeout {
        puts "âœ— TIMEOUT: CPU cores dialog not found in 10s"
        exit 1
    }
}

# Step 8: RAM (should be quick)
expect {
    "*RAM*" {
        puts "âœ“ RAM dialog - entering 8192MB"
        send "8192\r"
    }
    timeout {
        puts "âœ— TIMEOUT: RAM dialog not found in 10s"
        exit 1
    }
}

# Step 9: Bridge (should be quick)
expect {
    "*Bridge*" {
        puts "âœ“ Bridge dialog - entering vmbr0"
        send "vmbr0\r"
    }
    timeout {
        puts "âœ— TIMEOUT: Bridge dialog not found in 10s"
        exit 1
    }
}

# Step 10: IP Address (should be quick)
expect {
    "*IPv4*" {
        puts "âœ“ IP address dialog - entering 192.168.4.104/24"
        send "192.168.4.104/24\r"
    }
    timeout {
        puts "âœ— TIMEOUT: IP address dialog not found in 10s"
        exit 1
    }
}

# Step 11: Gateway (should be quick)
expect {
    "*Gateway*" {
        puts "âœ“ Gateway dialog - entering 192.168.4.1"
        send "192.168.4.1\r"
    }
    timeout {
        puts "âœ— TIMEOUT: Gateway dialog not found in 10s"
        exit 1
    }
}

# Speed through remaining optional settings
set timeout 5
expect {
    "*IPv6*" {
        puts "âœ“ IPv6 dialog - disabling"
        send "n\r"
        exp_continue
    }
    "*MTU*" {
        puts "âœ“ MTU dialog - using default"
        send "\r"
        exp_continue
    }
    "*DNS Search*" {
        puts "âœ“ DNS Search dialog - using default"
        send "\r"
        exp_continue
    }
    "*DNS Server*" {
        puts "âœ“ DNS Server dialog - using default"
        send "\r"
        exp_continue
    }
    "*MAC*" {
        puts "âœ“ MAC dialog - using default"
        send "\r"
        exp_continue
    }
    "*VLAN*" {
        puts "âœ“ VLAN dialog - using default"
        send "\r"
        exp_continue
    }
    "*Root SSH*" {
        puts "âœ“ Root SSH dialog - enabling"
        send "y\r"
        exp_continue
    }
    "*Verbose*" {
        puts "âœ“ Verbose dialog - enabling"
        send "y\r"
        exp_continue
    }
    "*Create CT*" {
        puts "âœ“ Final confirmation - creating container (this will take longer...)"
        # Longer timeout for actual container creation
        set timeout 300
        send "y\r"
    }
    timeout {
        puts "âœ— TIMEOUT: Skipped dialog in optional settings"
        exp_continue
    }
}

# Wait for completion with longer timeout
expect {
    "*Completed Successfully*" {
        puts "ðŸŽ‰ SUCCESS: Docker LXC container created!"
        exit 0
    }
    timeout {
        puts "âœ— TIMEOUT: Container creation took longer than 5 minutes"
        exit 1
    }
    eof {
        puts "âœ“ Script completed"
        exit 0
    }
}

expect eof