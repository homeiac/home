apiVersion: apps/v1
kind: Deployment
metadata:
  name: claudecodeui-blue
  namespace: claudecodeui
  labels:
    app: claudecodeui-blue
spec:
  replicas: 1
  selector:
    matchLabels:
      app: claudecodeui-blue
  template:
    metadata:
      labels:
        app: claudecodeui-blue
    spec:
      imagePullSecrets:
        - name: ghcr-credentials
      initContainers:
        # Fix permissions on PVC data, copy auth.db, and set up SSH keys for GitHub
        # Runs as root to fix ownership, then main container runs as claude user
        - name: init-permissions
          image: ghcr.io/homeiac/claudecodeui:main
          securityContext:
            runAsUser: 0
          command:
            - sh
            - -c
            - |
              # Fix ownership of entire .claude directory to claude user (uid 1001)
              echo "Fixing ownership of /data to claude user (uid 1001)..."
              chown -R 1001:1001 /data

              # Copy auth.db if missing
              if [ ! -s /data/auth.db ]; then
                echo "Copying auth.db from image to PVC..."
                cp /app/server/database/auth.db /data/auth.db 2>/dev/null || echo "No source auth.db"
                chown 1001:1001 /data/auth.db 2>/dev/null || true
              else
                echo "auth.db already exists ($(stat -c%s /data/auth.db) bytes)"
              fi

              # --- SSH key setup ---
              # Store SSH config in PVC so it persists across restarts
              SSH_DIR="/data/ssh"
              mkdir -p "$SSH_DIR"

              # Copy private key from mounted secret
              if [ -f /ssh-secret/id_ed25519 ]; then
                echo "Setting up SSH key for GitHub..."
                cp /ssh-secret/id_ed25519 "$SSH_DIR/id_ed25519"
                cp /ssh-secret/id_ed25519.pub "$SSH_DIR/id_ed25519.pub"
                chmod 700 "$SSH_DIR"
                chmod 600 "$SSH_DIR/id_ed25519"
                chmod 644 "$SSH_DIR/id_ed25519.pub"
              else
                echo "WARN: No SSH key secret mounted, skipping SSH setup"
              fi

              # Copy known_hosts from configmap
              if [ -f /ssh-known-hosts/known_hosts ]; then
                cp /ssh-known-hosts/known_hosts "$SSH_DIR/known_hosts"
                chmod 644 "$SSH_DIR/known_hosts"
              fi

              # Create SSH config pointing to PVC-backed path
              # In main container: /home/claude/.claude/ssh/ (via PVC mount)
              cat > "$SSH_DIR/config" <<'SSHEOF'
              Host github.com
                HostName github.com
                User git
                IdentityFile /home/claude/.claude/ssh/id_ed25519
                UserKnownHostsFile /home/claude/.claude/ssh/known_hosts
                StrictHostKeyChecking yes
              SSHEOF
              # Remove leading whitespace from heredoc
              sed -i 's/^              //' "$SSH_DIR/config"
              chmod 600 "$SSH_DIR/config"

              # Fix ownership of SSH dir
              chown -R 1001:1001 "$SSH_DIR"
              echo "SSH setup complete at /data/ssh/ (maps to /home/claude/.claude/ssh/)"
          volumeMounts:
            - name: claude-data
              mountPath: /data
            - name: github-ssh-key
              mountPath: /ssh-secret
              readOnly: true
            - name: github-known-hosts
              mountPath: /ssh-known-hosts
              readOnly: true
      containers:
        - name: claudecodeui
          image: ghcr.io/homeiac/claudecodeui:main
          imagePullPolicy: Always
          ports:
            - containerPort: 3001
          env:
            - name: PORT
              value: "3001"
            - name: NODE_ENV
              value: "production"
            - name: HOME
              value: "/home/claude"
            - name: DATABASE_PATH
              value: "/home/claude/.claude/auth.db"
            # MQTT Bridge Configuration
            - name: MQTT_ENABLED
              value: "true"
            - name: MQTT_BROKER_URL
              value: "mqtt://homeassistant.maas:1883"
            - name: MQTT_COMMAND_TOPIC
              value: "claude/command"
            - name: MQTT_RESPONSE_TOPIC
              value: "claude/home/response"
            - name: MQTT_APPROVAL_REQUEST_TOPIC
              value: "claude/approval-request"
            - name: MQTT_APPROVAL_RESPONSE_TOPIC
              value: "claude/approval-response"
            - name: MQTT_CLIENT_ID
              value: "claudecodeui-home"
            - name: MQTT_APPROVAL_TIMEOUT
              value: "60000"
            - name: MQTT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: mqtt-credentials
                  key: username
            - name: MQTT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mqtt-credentials
                  key: password
            # SSH config for GitHub (keys stored in PVC at /home/claude/.claude/ssh/)
            - name: GIT_SSH_COMMAND
              value: "ssh -F /home/claude/.claude/ssh/config"
            # Git identity for commits
            - name: GIT_AUTHOR_NAME
              value: "homeiac"
            - name: GIT_COMMITTER_NAME
              value: "homeiac"
            - name: GIT_AUTHOR_EMAIL
              value: "noreply@github.com"
            - name: GIT_COMMITTER_EMAIL
              value: "noreply@github.com"
            # GitHub PAT for API access (gh CLI if available)
            - name: GH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: github-ssh-key
                  key: gh_token
                  optional: true
          volumeMounts:
            - name: claude-data
              mountPath: /home/claude/.claude
            - name: claude-projects
              mountPath: /home/claude/projects
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "2Gi"
              cpu: "2000m"
      volumes:
        - name: claude-data
          persistentVolumeClaim:
            claimName: claude-data-blue
        - name: claude-projects
          persistentVolumeClaim:
            claimName: claude-projects-blue
        - name: github-ssh-key
          secret:
            secretName: github-ssh-key
            optional: true
            defaultMode: 0600
        - name: github-known-hosts
          configMap:
            name: github-known-hosts
            optional: true
