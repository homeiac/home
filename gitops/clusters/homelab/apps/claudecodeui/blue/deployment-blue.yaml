apiVersion: apps/v1
kind: Deployment
metadata:
  name: claudecodeui-blue
  namespace: claudecodeui
  labels:
    app: claudecodeui-blue
spec:
  replicas: 1
  selector:
    matchLabels:
      app: claudecodeui-blue
  template:
    metadata:
      labels:
        app: claudecodeui-blue
    spec:
      imagePullSecrets:
        - name: ghcr-credentials
      initContainers:
        # Fix permissions on PVC data and copy auth.db if needed
        # Runs as root to fix ownership, then main container runs as claude user
        - name: init-permissions
          image: ghcr.io/homeiac/claudecodeui:1.15.0
          securityContext:
            runAsUser: 0
          command:
            - sh
            - -c
            - |
              # Fix ownership of entire .claude directory to claude user (uid 1001)
              echo "Fixing ownership of /data to claude user (uid 1001)..."
              chown -R 1001:1001 /data

              # Copy auth.db if missing
              if [ ! -s /data/auth.db ]; then
                echo "Copying auth.db from image to PVC..."
                cp /app/server/database/auth.db /data/auth.db 2>/dev/null || echo "No source auth.db"
                chown 1001:1001 /data/auth.db 2>/dev/null || true
              else
                echo "auth.db already exists ($(stat -c%s /data/auth.db) bytes)"
              fi
          volumeMounts:
            - name: claude-data
              mountPath: /data
      containers:
        - name: claudecodeui
          image: ghcr.io/homeiac/claudecodeui:1.15.0
          imagePullPolicy: Always
          ports:
            - containerPort: 3001
          env:
            - name: PORT
              value: "3001"
            - name: NODE_ENV
              value: "production"
            - name: HOME
              value: "/home/claude"
            - name: DATABASE_PATH
              value: "/home/claude/.claude/auth.db"
            # MQTT Bridge Configuration
            - name: MQTT_ENABLED
              value: "true"
            - name: MQTT_BROKER_URL
              value: "mqtt://homeassistant.maas:1883"
            - name: MQTT_COMMAND_TOPIC
              value: "claude/command"
            - name: MQTT_RESPONSE_TOPIC
              value: "claude/home/response"
            - name: MQTT_APPROVAL_REQUEST_TOPIC
              value: "claude/approval-request"
            - name: MQTT_APPROVAL_RESPONSE_TOPIC
              value: "claude/approval-response"
            - name: MQTT_CLIENT_ID
              value: "claudecodeui-home"
            - name: MQTT_APPROVAL_TIMEOUT
              value: "60000"
            - name: MQTT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: mqtt-credentials
                  key: username
            - name: MQTT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mqtt-credentials
                  key: password
          volumeMounts:
            - name: claude-data
              mountPath: /home/claude/.claude
            - name: claude-projects
              mountPath: /home/claude/projects
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "2Gi"
              cpu: "2000m"
      volumes:
        - name: claude-data
          persistentVolumeClaim:
            claimName: claude-data-blue
        - name: claude-projects
          persistentVolumeClaim:
            claimName: claude-projects-blue
