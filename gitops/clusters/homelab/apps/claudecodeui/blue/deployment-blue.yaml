apiVersion: apps/v1
kind: Deployment
metadata:
  name: claudecodeui-blue
  namespace: claudecodeui
  labels:
    app: claudecodeui-blue
spec:
  replicas: 1
  selector:
    matchLabels:
      app: claudecodeui-blue
  template:
    metadata:
      labels:
        app: claudecodeui-blue
    spec:
      imagePullSecrets:
        - name: ghcr-credentials
      initContainers:
        # Fix permissions on PVC data, copy auth.db, and set up SSH keys for GitHub + Proxmox
        # Runs as root to fix ownership, then main container runs as claude user
        - name: init-permissions
          image: ghcr.io/homeiac/claudecodeui:main
          securityContext:
            runAsUser: 0
          command:
            - sh
            - -c
            - |
              # Fix ownership of entire .claude directory to claude user (uid 1001)
              echo "Fixing ownership of /data to claude user (uid 1001)..."
              chown -R 1001:1001 /data

              # Copy auth.db if missing
              if [ ! -s /data/auth.db ]; then
                echo "Copying auth.db from image to PVC..."
                cp /app/server/database/auth.db /data/auth.db 2>/dev/null || echo "No source auth.db"
                chown 1001:1001 /data/auth.db 2>/dev/null || true
              else
                echo "auth.db already exists ($(stat -c%s /data/auth.db) bytes)"
              fi

              # --- SSH key setup ---
              # Store SSH config in PVC so it persists across restarts
              SSH_DIR="/data/ssh"
              mkdir -p "$SSH_DIR"

              # Copy GitHub private key from mounted secret
              if [ -f /ssh-secret/id_ed25519 ]; then
                echo "Setting up SSH key for GitHub..."
                cp /ssh-secret/id_ed25519 "$SSH_DIR/id_ed25519"
                cp /ssh-secret/id_ed25519.pub "$SSH_DIR/id_ed25519.pub"
                chmod 700 "$SSH_DIR"
                chmod 600 "$SSH_DIR/id_ed25519"
                chmod 644 "$SSH_DIR/id_ed25519.pub"
              else
                echo "WARN: No GitHub SSH key secret mounted, skipping GitHub SSH setup"
              fi

              # Copy Proxmox private key from mounted secret
              if [ -f /proxmox-ssh-secret/id_ed25519 ]; then
                echo "Setting up SSH key for Proxmox hosts..."
                cp /proxmox-ssh-secret/id_ed25519 "$SSH_DIR/proxmox_ed25519"
                chmod 600 "$SSH_DIR/proxmox_ed25519"
              else
                echo "WARN: No Proxmox SSH key secret mounted, skipping Proxmox SSH setup"
              fi

              # Copy known_hosts from configmap (GitHub hosts)
              if [ -f /ssh-known-hosts/known_hosts ]; then
                cp /ssh-known-hosts/known_hosts "$SSH_DIR/known_hosts"
                chmod 644 "$SSH_DIR/known_hosts"
              fi

              # Scan and add Proxmox host keys to known_hosts
              echo "Scanning Proxmox host keys..."
              for HOST in still-fawn.maas chief-horse.maas fun-bedbug.maas pumped-piglet.maas rapid-civet.maas 192.168.4.122; do
                ssh-keyscan -T 3 "$HOST" >> "$SSH_DIR/known_hosts" 2>/dev/null || echo "WARN: Could not scan $HOST"
              done

              # Create SSH config pointing to PVC-backed path
              # In main container: /home/claude/.claude/ssh/ (via PVC mount)
              cat > "$SSH_DIR/config" <<'SSHEOF'
              Host github.com
                HostName github.com
                User git
                IdentityFile /home/claude/.claude/ssh/id_ed25519
                UserKnownHostsFile /home/claude/.claude/ssh/known_hosts
                StrictHostKeyChecking yes

              # Proxmox hosts - use dedicated Proxmox SSH key
              # pve.maas is NOT in MAAS DNS (NXDOMAIN), so we alias to its IP
              Host pve pve.maas
                HostName 192.168.4.122
                User root
                IdentityFile /home/claude/.claude/ssh/proxmox_ed25519
                UserKnownHostsFile /home/claude/.claude/ssh/known_hosts
                StrictHostKeyChecking no

              Host still-fawn.maas
                User root
                IdentityFile /home/claude/.claude/ssh/proxmox_ed25519
                UserKnownHostsFile /home/claude/.claude/ssh/known_hosts
                StrictHostKeyChecking no

              Host chief-horse.maas
                User root
                IdentityFile /home/claude/.claude/ssh/proxmox_ed25519
                UserKnownHostsFile /home/claude/.claude/ssh/known_hosts
                StrictHostKeyChecking no

              Host fun-bedbug.maas
                User root
                IdentityFile /home/claude/.claude/ssh/proxmox_ed25519
                UserKnownHostsFile /home/claude/.claude/ssh/known_hosts
                StrictHostKeyChecking no

              Host pumped-piglet.maas
                User root
                IdentityFile /home/claude/.claude/ssh/proxmox_ed25519
                UserKnownHostsFile /home/claude/.claude/ssh/known_hosts
                StrictHostKeyChecking no

              Host rapid-civet.maas
                User root
                IdentityFile /home/claude/.claude/ssh/proxmox_ed25519
                UserKnownHostsFile /home/claude/.claude/ssh/known_hosts
                StrictHostKeyChecking no
              SSHEOF
              # Remove leading whitespace from heredoc
              sed -i 's/^              //' "$SSH_DIR/config"
              chmod 600 "$SSH_DIR/config"

              # Fix ownership of SSH dir
              chown -R 1001:1001 "$SSH_DIR"

              # Symlink ~/.ssh -> ~/.claude/ssh so plain 'ssh' commands find the config
              # (GIT_SSH_COMMAND only covers git; Claude Code runs ssh directly via ~/.ssh)
              HOME_SSH="/home/claude/.ssh"
              rm -rf "$HOME_SSH"
              ln -sf /home/claude/.claude/ssh "$HOME_SSH"
              chown -h 1001:1001 "$HOME_SSH"
              echo "SSH setup complete at /data/ssh/ (symlinked from ~/.ssh)"

              # --- Auto-clone repos and register as projects ---
              PROJECTS_DIR="/projects"
              CONFIG_FILE="/data/project-config.json"
              REPOS_FILE="/github-repos/repos"

              # Read GH_TOKEN from secret if available (for private repo HTTPS auth)
              GH_TOKEN=""
              if [ -f /ssh-secret/gh_token ]; then
                GH_TOKEN=$(cat /ssh-secret/gh_token)
              fi

              # Initialize project-config.json if missing
              if [ ! -f "$CONFIG_FILE" ]; then
                echo "{}" > "$CONFIG_FILE"
              fi

              # Mark projects dir as safe for git (init runs as root, repos owned by uid 1001)
              git config --global --add safe.directory '*'

              if [ -f "$REPOS_FILE" ]; then
                echo "Processing repo list..."
                while IFS= read -r line || [ -n "$line" ]; do
                  # Skip comments and empty lines
                  case "$line" in
                    '#'*|'') continue ;;
                  esac

                  REPO_URL=$(echo "$line" | awk '{print $1}')
                  DIR_NAME=$(echo "$line" | awk '{print $2}')
                  DISPLAY_NAME=$(echo "$line" | awk '{print $3}')
                  [ -z "$DIR_NAME" ] && continue
                  [ -z "$DISPLAY_NAME" ] && DISPLAY_NAME="$DIR_NAME"

                  CLONE_DIR="$PROJECTS_DIR/$DIR_NAME"
                  PROJECT_PATH="/home/claude/projects/$DIR_NAME"

                  # Clone if not already present
                  if [ ! -d "$CLONE_DIR/.git" ]; then
                    echo "Cloning $REPO_URL -> $CLONE_DIR ..."
                    # Inject PAT into HTTPS URL for private repos
                    CLONE_URL="$REPO_URL"
                    if [ -n "$GH_TOKEN" ]; then
                      CLONE_URL=$(echo "$REPO_URL" | sed "s|https://github.com|https://${GH_TOKEN}@github.com|")
                    fi
                    git clone "$CLONE_URL" "$CLONE_DIR" 2>&1 || echo "WARN: Failed to clone $REPO_URL"
                    # Remove token from remote URL after clone
                    if [ -n "$GH_TOKEN" ] && [ -d "$CLONE_DIR/.git" ]; then
                      git -C "$CLONE_DIR" remote set-url origin "$REPO_URL"
                    fi
                  else
                    echo "Repo $DIR_NAME already cloned, pulling latest..."
                    git -C "$CLONE_DIR" pull --ff-only 2>&1 || echo "WARN: Pull failed for $DIR_NAME"
                  fi

                  # Register in project-config.json using jq
                  # Key format: path with / replaced by -
                  PROJECT_KEY=$(echo "$PROJECT_PATH" | sed 's|/|-|g')
                  if ! grep -qF -- "$PROJECT_KEY" "$CONFIG_FILE"; then
                    echo "Registering project: $DISPLAY_NAME ($PROJECT_PATH)"
                    TMP_CFG=$(mktemp)
                    jq --arg key "$PROJECT_KEY" \
                       --arg path "$PROJECT_PATH" \
                       --arg name "$DISPLAY_NAME" \
                       '.[$key] = {"manuallyAdded": true, "originalPath": $path, "displayName": $name}' \
                       "$CONFIG_FILE" > "$TMP_CFG" && mv "$TMP_CFG" "$CONFIG_FILE"
                  fi
                done < "$REPOS_FILE"
              fi

              # Fix ownership of projects
              chown -R 1001:1001 "$PROJECTS_DIR"
              chown 1001:1001 "$CONFIG_FILE"
              echo "Project setup complete"

              # --- Homelab .env setup ---
              # Copy .env from secret into PVC so scripts can source it
              if [ -f /homelab-env-secret/dot-env ]; then
                echo "Copying homelab .env from secret to PVC..."
                cp /homelab-env-secret/dot-env /data/.env
                chown 1001:1001 /data/.env
                chmod 600 /data/.env
                echo "Homelab .env installed ($(wc -l < /data/.env) lines)"
              else
                echo "WARN: No homelab-env secret mounted, skipping .env setup"
              fi
          volumeMounts:
            - name: claude-data
              mountPath: /data
            - name: claude-projects
              mountPath: /projects
            - name: github-ssh-key
              mountPath: /ssh-secret
              readOnly: true
            - name: proxmox-ssh-key
              mountPath: /proxmox-ssh-secret
              readOnly: true
            - name: github-known-hosts
              mountPath: /ssh-known-hosts
              readOnly: true
            - name: github-repos
              mountPath: /github-repos
              readOnly: true
            - name: homelab-env-file
              mountPath: /homelab-env-secret
              readOnly: true
      containers:
        - name: claudecodeui
          image: ghcr.io/homeiac/claudecodeui:main
          imagePullPolicy: Always
          ports:
            - containerPort: 3001
          env:
            - name: PORT
              value: "3001"
            - name: NODE_ENV
              value: "production"
            - name: HOME
              value: "/home/claude"
            - name: DATABASE_PATH
              value: "/home/claude/.claude/auth.db"
            # MQTT Bridge Configuration
            - name: MQTT_ENABLED
              value: "true"
            - name: MQTT_BROKER_URL
              value: "mqtt://homeassistant.maas:1883"
            - name: MQTT_COMMAND_TOPIC
              value: "claude/command"
            - name: MQTT_RESPONSE_TOPIC
              value: "claude/home/response"
            - name: MQTT_APPROVAL_REQUEST_TOPIC
              value: "claude/approval-request"
            - name: MQTT_APPROVAL_RESPONSE_TOPIC
              value: "claude/approval-response"
            - name: MQTT_CLIENT_ID
              value: "claudecodeui-home"
            - name: MQTT_APPROVAL_TIMEOUT
              value: "60000"
            - name: MQTT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: mqtt-credentials
                  key: username
            - name: MQTT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mqtt-credentials
                  key: password
            # SSH config for GitHub (keys stored in PVC at /home/claude/.claude/ssh/)
            - name: GIT_SSH_COMMAND
              value: "ssh -F /home/claude/.claude/ssh/config"
            # Git identity for commits
            - name: GIT_AUTHOR_NAME
              value: "homeiac"
            - name: GIT_COMMITTER_NAME
              value: "homeiac"
            - name: GIT_AUTHOR_EMAIL
              value: "noreply@github.com"
            - name: GIT_COMMITTER_EMAIL
              value: "noreply@github.com"
            # GitHub PAT for API access (gh CLI if available)
            - name: GH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: github-ssh-key
                  key: gh_token
                  optional: true
            # Homelab credentials (from SOPS-encrypted secret)
            - name: HA_TOKEN
              valueFrom:
                secretKeyRef:
                  name: homelab-env
                  key: HA_TOKEN
                  optional: true
            - name: HA_URL
              valueFrom:
                secretKeyRef:
                  name: homelab-env
                  key: HA_URL
                  optional: true
            - name: HOME_ASSISTANT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: homelab-env
                  key: HOME_ASSISTANT_TOKEN
                  optional: true
            - name: HOME_ASSISTANT_URL
              valueFrom:
                secretKeyRef:
                  name: homelab-env
                  key: HOME_ASSISTANT_URL
                  optional: true
            - name: API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: homelab-env
                  key: API_TOKEN
                  optional: true
            - name: PBS_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: homelab-env
                  key: PBS_API_TOKEN
                  optional: true
            - name: PBS_URL
              valueFrom:
                secretKeyRef:
                  name: homelab-env
                  key: PBS_URL
                  optional: true
            - name: PVE_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: homelab-env
                  key: PVE_ROOT_PASSWORD
                  optional: true
            - name: MAAS_URL
              valueFrom:
                secretKeyRef:
                  name: homelab-env
                  key: MAAS_URL
                  optional: true
            - name: MAAS_USER
              valueFrom:
                secretKeyRef:
                  name: homelab-env
                  key: MAAS_USER
                  optional: true
            - name: MAAS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: homelab-env
                  key: MAAS_PASSWORD
                  optional: true
            - name: FRIGATE_MQTT_USER
              valueFrom:
                secretKeyRef:
                  name: homelab-env
                  key: FRIGATE_MQTT_USER
                  optional: true
            - name: FRIGATE_MQTT_PASS
              valueFrom:
                secretKeyRef:
                  name: homelab-env
                  key: FRIGATE_MQTT_PASS
                  optional: true
            - name: CRUCIBLE_USER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: homelab-env
                  key: CRUCIBLE_USER_PASSWORD
                  optional: true
          volumeMounts:
            - name: claude-data
              mountPath: /home/claude/.claude
            - name: claude-projects
              mountPath: /home/claude/projects
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "2Gi"
              cpu: "2000m"
      volumes:
        - name: claude-data
          persistentVolumeClaim:
            claimName: claude-data-blue
        - name: claude-projects
          persistentVolumeClaim:
            claimName: claude-projects-blue
        - name: github-ssh-key
          secret:
            secretName: github-ssh-key
            optional: true
            defaultMode: 0600
        - name: proxmox-ssh-key
          secret:
            secretName: proxmox-ssh-key
            optional: true
            defaultMode: 0600
        - name: github-known-hosts
          configMap:
            name: github-known-hosts
            optional: true
        - name: github-repos
          configMap:
            name: github-repos
        - name: homelab-env-file
          secret:
            secretName: homelab-env
            optional: true
            items:
              - key: dot-env
                path: dot-env
