prometheus:
  prometheusSpec:
    # Retain 30 days of raw data (adjust as needed)
    retention: 30d
    nodeSelector:
      kubernetes.io/hostname: k3s-vm-pumped-piglet-gpu
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          storageClassName: prometheus-storage
          resources:
            requests:
              storage: 500Gi
    # Mount file_sd targets from ConfigMap (managed by: homelab monitoring generate-targets)
    volumes:
      - name: file-sd-targets
        configMap:
          name: prometheus-scrape-targets
    volumeMounts:
      - name: file-sd-targets
        mountPath: /etc/prometheus/file-sd
        readOnly: true
    additionalScrapeConfigs:
      # All bare-metal targets are discovered via file_sd_configs.
      # The same targets.json file is shared; each job filters by the "job" label.
      # To update targets: poetry run homelab monitoring generate-targets
      - job_name: "proxmox-node-exporter"
        file_sd_configs:
          - files: ["/etc/prometheus/file-sd/targets.json"]
        relabel_configs:
          - source_labels: [job]
            regex: proxmox-node-exporter
            action: keep
          - source_labels: [hostname]
            target_label: instance
      - job_name: "proxmox-zfs-exporter"
        file_sd_configs:
          - files: ["/etc/prometheus/file-sd/targets.json"]
        relabel_configs:
          - source_labels: [job]
            regex: proxmox-zfs-exporter
            action: keep
          - source_labels: [hostname]
            target_label: instance
      - job_name: "proxmox-pve-exporter"
        metrics_path: /pve
        file_sd_configs:
          - files: ["/etc/prometheus/file-sd/targets.json"]
        relabel_configs:
          - source_labels: [job]
            regex: proxmox-pve-exporter
            action: keep
          - source_labels: [hostname]
            target_label: instance
      - job_name: "crucible-node-exporter"
        file_sd_configs:
          - files: ["/etc/prometheus/file-sd/targets.json"]
        relabel_configs:
          - source_labels: [job]
            regex: crucible-node-exporter
            action: keep
          - source_labels: [hostname]
            target_label: instance
      - job_name: "nvidia-dcgm-exporter"
        kubernetes_sd_configs:
          - role: service
            namespaces:
              names:
                - gpu-operator
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_name]
            action: keep
            regex: nvidia-dcgm-exporter
          - source_labels: [__meta_kubernetes_service_port_name]
            action: keep
            regex: gpu-metrics

alertmanager:
  alertmanagerSpec:
    secrets:
      - smtp-credentials
  config:
    route:
      receiver: email
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
    receivers:
      - name: email
        email_configs:
          - to: g_skumar@yahoo.com
            from: alertmanager@home.panderosystems.com
            smarthost: smtp.mail.yahoo.com:587
            auth_username: g_skumar@yahoo.com
            auth_password_file: /etc/alertmanager/secrets/smtp-credentials/pass
            require_tls: true

grafana:
  service:
    type: NodePort
    nodePort: 32080
  # Admin credentials from SOPS-encrypted secret
  admin:
    existingSecret: grafana-admin-credentials
    userKey: admin-user
    passwordKey: admin-password
  persistence:
    enabled: true
    accessModes:
      - ReadWriteOnce
    size: 10Gi
    storageClassName: local-path
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          preference:
            matchExpressions:
              - key: kubernetes.io/hostname
                operator: In
                values:
                  - k3s-vm-pumped-piglet-gpu
  smtp:
    enabled: true
    existingSecret: smtp-credentials
    userKey: user
    passwordKey: pass
    host: smtp.mail.yahoo.com:587
    fromAddress: g_skumar@yahoo.com
    skipVerify: false
  grafana.ini:
    unified_alerting:
      enabled: true
    alerting:
      enabled: false
    smtp:
      enabled: true
      host: smtp.mail.yahoo.com:587
      user: $__file{/etc/secrets/smtp-credentials/user}
      password: $__file{/etc/secrets/smtp-credentials/pass}
      from_address: g_skumar@yahoo.com
      skip_verify: false
  extraSecretMounts:
    - name: smtp-credentials
      secretName: smtp-credentials
      mountPath: /etc/secrets/smtp-credentials
      readOnly: true
