apiVersion: v1
kind: ConfigMap
metadata:
  name: nut-scripts
  namespace: monitoring
data:
  nut-notify.sh: |
    #!/bin/bash
    # nut-notify.sh - Tiered shutdown script for NUT UPS events
    # Location: /root/nut-notify.sh on pve
    #
    # Tiered shutdown based on battery level:
    #   40%: Shutdown heavy hosts (pumped-piglet, still-fawn)
    #   20%: Shutdown MAAS VM (102)
    #   10%: Shutdown chief-horse, then pve itself

    set -e

    LOG_FILE="/var/log/nut-notify.log"
    STATE_FILE="/var/run/nut-shutdown-state"
    UPS_NAME="${UPSNAME:-ups}"

    # Notification settings
    HOSTNAME=$(hostname)

    TIER1_THRESHOLD=40
    TIER2_THRESHOLD=20
    TIER3_THRESHOLD=10

    TIER1_HOSTS=("pumped-piglet.maas" "still-fawn.maas")
    TIER3_HOSTS=("chief-horse.maas")
    MAAS_VMID=102

    log() {
        local level="$1"
        shift
        local msg="$*"
        local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
        echo "[$timestamp] [$level] $msg" | tee -a "$LOG_FILE"
        logger -t nut-notify "[$level] $msg"
    }

    send_notification() {
        local subject="$1"
        local body="$2"
        local charge=$(get_battery_charge)
        local runtime=$(upsc "$UPS_NAME@localhost" battery.runtime 2>/dev/null || echo "unknown")
        local runtime_mins=$((runtime / 60))

        # Build detailed message
        local full_body="$body

UPS Status:
  Battery: ${charge}%
  Runtime: ${runtime_mins} minutes
  Host: ${HOSTNAME}
  Time: $(date)

Tiered Shutdown Status:
  Tier 1 (40%): $(tier_done 1 && echo "DONE" || echo "pending")
  Tier 2 (20%): $(tier_done 2 && echo "DONE" || echo "pending")
  Tier 3 (10%): $(tier_done 3 && echo "DONE" || echo "pending")
"

        # Send via ntfy.sh (works even when K8s/Prometheus is down)
        # Topic is unique to this homelab but not secret - anyone can subscribe
        curl -s \
            -H "Title: [HOMELAB UPS] $subject" \
            -H "Priority: high" \
            -H "Tags: electric_plug,warning" \
            -d "$full_body" \
            "https://ntfy.sh/homelab-pve-ups-alerts" 2>/dev/null &

        log "INFO" "Notification sent: $subject"
    }

    get_battery_charge() {
        local charge
        charge=$(upsc "$UPS_NAME@localhost" battery.charge 2>/dev/null || echo "0")
        echo "${charge%.*}"
    }

    get_ups_status() {
        upsc "$UPS_NAME@localhost" ups.status 2>/dev/null || echo "UNKNOWN"
    }

    tier_done() {
        local tier="$1"
        [[ -f "$STATE_FILE" ]] && grep -q "^TIER${tier}_DONE$" "$STATE_FILE"
    }

    mark_tier_done() {
        local tier="$1"
        echo "TIER${tier}_DONE" >> "$STATE_FILE"
        log "INFO" "Marked Tier $tier as complete"
    }

    reset_state() {
        if [[ -f "$STATE_FILE" ]]; then
            rm -f "$STATE_FILE"
            log "INFO" "Reset shutdown state - power restored"
        fi
    }

    shutdown_host() {
        local host="$1"
        log "WARN" "Initiating shutdown of $host"
        if ssh -o ConnectTimeout=10 -o BatchMode=yes "root@$host" "shutdown -h now" 2>/dev/null; then
            log "INFO" "Shutdown command sent to $host"
            return 0
        else
            log "ERROR" "Failed to send shutdown to $host"
            return 1
        fi
    }

    shutdown_local_vm() {
        local vmid="$1"
        log "WARN" "Initiating shutdown of local VM $vmid"
        if qm shutdown "$vmid" --timeout 60 2>/dev/null; then
            log "INFO" "Shutdown initiated for VM $vmid"
            return 0
        else
            log "WARN" "Graceful shutdown failed, forcing stop of VM $vmid"
            qm stop "$vmid" --timeout 30 2>/dev/null || true
            return 0
        fi
    }

    execute_tier1() {
        if tier_done 1; then
            log "DEBUG" "Tier 1 already executed, skipping"
            return 0
        fi
        log "WARN" "=== TIER 1 SHUTDOWN: Heavy hosts (battery <= ${TIER1_THRESHOLD}%) ==="
        send_notification "Tier 1 Shutdown" "Shutting down heavy hosts: pumped-piglet, still-fawn (GPU/K3s workers)"
        for host in "${TIER1_HOSTS[@]}"; do
            shutdown_host "$host" &
        done
        wait
        mark_tier_done 1
    }

    execute_tier2() {
        if tier_done 2; then
            log "DEBUG" "Tier 2 already executed, skipping"
            return 0
        fi
        log "WARN" "=== TIER 2 SHUTDOWN: MAAS VM (battery <= ${TIER2_THRESHOLD}%) ==="
        send_notification "Tier 2 Shutdown" "Shutting down MAAS VM (DHCP/DNS server)"
        shutdown_local_vm "$MAAS_VMID"
        mark_tier_done 2
    }

    execute_tier3() {
        if tier_done 3; then
            log "DEBUG" "Tier 3 already executed, skipping"
            return 0
        fi
        log "CRIT" "=== TIER 3 SHUTDOWN: Critical infrastructure (battery <= ${TIER3_THRESHOLD}%) ==="
        send_notification "Tier 3 - FINAL SHUTDOWN" "Shutting down all remaining infrastructure. pve will shutdown in 10 seconds. Goodbye!"
        for host in "${TIER3_HOSTS[@]}"; do
            shutdown_host "$host" &
        done
        wait
        mark_tier_done 3
        sleep 10
        log "CRIT" "Initiating pve shutdown..."
        shutdown -h now "UPS battery critical - emergency shutdown"
    }

    process_battery_level() {
        local charge
        charge=$(get_battery_charge)
        log "INFO" "Current battery charge: ${charge}%"

        if [[ "$charge" -le "$TIER3_THRESHOLD" ]]; then
            execute_tier1
            execute_tier2
            execute_tier3
        elif [[ "$charge" -le "$TIER2_THRESHOLD" ]]; then
            execute_tier1
            execute_tier2
        elif [[ "$charge" -le "$TIER1_THRESHOLD" ]]; then
            execute_tier1
        fi
    }

    main() {
        local notify_type="${NOTIFYTYPE:-UNKNOWN}"
        local ups_name="${UPSNAME:-ups}"
        local battery_charge
        local ups_status

        battery_charge=$(get_battery_charge)
        ups_status=$(get_ups_status)

        log "INFO" "Event: $notify_type | UPS: $ups_name | Battery: ${battery_charge}% | Status: $ups_status"

        case "$notify_type" in
            ONLINE)
                log "INFO" "Power restored - UPS back online"
                send_notification "Power Restored" "Mains power has been restored. UPS back online."
                reset_state
                ;;
            ONBATT)
                log "WARN" "Running on battery power!"
                send_notification "POWER OUTAGE - On Battery" "Power outage detected! Running on UPS battery power. Tiered shutdown will begin if battery drops below 40%."
                process_battery_level
                ;;
            LOWBATT)
                log "CRIT" "Low battery warning from UPS!"
                send_notification "LOW BATTERY - Emergency Shutdown" "UPS battery critically low! Executing full tiered shutdown of all hosts."
                execute_tier1
                execute_tier2
                execute_tier3
                ;;
            FSD)
                log "CRIT" "Forced shutdown requested!"
                send_notification "FORCED SHUTDOWN" "Forced shutdown signal received. Executing emergency shutdown of all hosts."
                execute_tier1
                execute_tier2
                execute_tier3
                ;;
            COMMOK)
                log "INFO" "Communication with UPS restored"
                ;;
            COMMBAD)
                log "WARN" "Lost communication with UPS"
                ;;
            SHUTDOWN)
                log "CRIT" "System shutdown initiated by UPS"
                ;;
            REPLBATT)
                log "WARN" "UPS battery needs replacement"
                ;;
            *)
                log "DEBUG" "Unhandled event type: $notify_type"
                ;;
        esac
    }

    main "$@"

  test-nut-status.sh: |
    #!/bin/bash
    # test-nut-status.sh - Quick UPS health check via NUT

    set -e

    UPS_NAME="${1:-ups}"

    echo "=== NUT UPS Status Check ==="
    echo ""

    if ! command -v upsc &>/dev/null; then
        echo "ERROR: upsc not found. Is NUT installed?"
        exit 1
    fi

    if ! upsc "$UPS_NAME@localhost" &>/dev/null; then
        echo "ERROR: Cannot connect to UPS '$UPS_NAME'"
        echo "Check: systemctl status nut-server"
        exit 1
    fi

    echo "UPS: $UPS_NAME"
    echo ""

    BATTERY_CHARGE=$(upsc "$UPS_NAME@localhost" battery.charge 2>/dev/null || echo "N/A")
    BATTERY_RUNTIME=$(upsc "$UPS_NAME@localhost" battery.runtime 2>/dev/null || echo "N/A")
    UPS_STATUS=$(upsc "$UPS_NAME@localhost" ups.status 2>/dev/null || echo "N/A")
    UPS_LOAD=$(upsc "$UPS_NAME@localhost" ups.load 2>/dev/null || echo "N/A")
    INPUT_VOLTAGE=$(upsc "$UPS_NAME@localhost" input.voltage 2>/dev/null || echo "N/A")
    OUTPUT_VOLTAGE=$(upsc "$UPS_NAME@localhost" output.voltage 2>/dev/null || echo "N/A")

    if [[ "$BATTERY_RUNTIME" != "N/A" ]]; then
        RUNTIME_MINS=$((BATTERY_RUNTIME / 60))
    else
        RUNTIME_MINS="N/A"
    fi

    echo "┌─────────────────────────────────────┐"
    echo "│ Battery Charge:  ${BATTERY_CHARGE}%"
    echo "│ Battery Runtime: ${RUNTIME_MINS} minutes"
    echo "│ UPS Status:      ${UPS_STATUS}"
    echo "│ Load:            ${UPS_LOAD}%"
    echo "│ Input Voltage:   ${INPUT_VOLTAGE}V"
    echo "│ Output Voltage:  ${OUTPUT_VOLTAGE}V"
    echo "└─────────────────────────────────────┘"
    echo ""

    case "$UPS_STATUS" in
        OL*)
            echo "✓ Status: ONLINE (on mains power)"
            ;;
        OB*)
            echo "⚠ Status: ON BATTERY"
            ;;
        LB*)
            echo "✗ Status: LOW BATTERY - shutdown imminent!"
            ;;
        *)
            echo "? Status: $UPS_STATUS"
            ;;
    esac

    echo ""
    echo "Tiered Shutdown Thresholds:"
    echo "  ≤40%: Shutdown pumped-piglet, still-fawn"
    echo "  ≤20%: Shutdown MAAS VM (102)"
    echo "  ≤10%: Shutdown chief-horse, pve"
